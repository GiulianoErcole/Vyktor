<!doctype html>
<html lang="en"><head><meta charset="utf-8"><title>Vyktor Dashboard v1.2.3 (Stable)</title>
<style>
body{background:#0b0b0b;color:#e0e0e0;font-family:Arial, sans-serif;margin:20px;}
h1{color:#00ffff}.status{margin-bottom:10px;opacity:.8}.container{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.card{background:#111;padding:12px;border:1px solid #222;border-radius:8px}.task{background:#151515;padding:10px;margin:10px 0;border-radius:8px;border:1px solid #222}
.progress{height:10px;background:#333;border-radius:5px;margin-top:4px;overflow:hidden}.bar{height:10px;background:#00e0ff;width:0%;transition:width .3s}
#log{max-height:240px;overflow:auto;background:#000;color:#0f0;padding:10px;border-radius:8px;font-family:monospace}canvas{width:100%;height:180px;background:#0c0c0c;border:1px solid #222;border-radius:8px}.small{opacity:.7;font-size:12px}
</style></head>
<body>
<h1>Vyktor Dashboard v1.2.3 (Stable)</h1>
<div class="status" id="ws-status">WS: connecting...</div>
<div class="container">
  <div class="card"><h3>Tasks</h3><div id="tasks"></div></div>
  <div class="card"><h3>Metrics</h3><div class="small">OK% and Avg Runtime (rolling)</div><canvas id="okChart"></canvas><canvas id="rtChart" style="margin-top:8px"></canvas></div>
</div>
<h3>Live Feed</h3><div id="log" class="card"></div>
<script>
const statusEl=document.getElementById("ws-status"); const ws=new WebSocket("ws://127.0.0.1:8765");
ws.onopen=()=>statusEl.textContent="WS: connected"; ws.onclose=()=>statusEl.textContent="WS: disconnected"; ws.onerror=()=>statusEl.textContent="WS: error";
const maxPoints=120; let okPts=[], rtPts=[];
function drawLine(canvas, pts, label){
  const ctx=canvas.getContext('2d'); const dpr=window.devicePixelRatio||1;
  canvas.width=canvas.clientWidth*dpr; canvas.height=canvas.clientHeight*dpr; ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight); ctx.strokeStyle='#00e0ff'; ctx.beginPath();
  const n=pts.length; if(!n) return; const xmin=0, xmax=Math.max(1,n-1);
  const ymin=Math.min(...pts), ymax=Math.max(...pts); const pad=8, W=canvas.clientWidth-2*pad, H=canvas.clientHeight-2*pad;
  function mapx(i){return pad+(i/xmax)*W} function mapy(v){const a=ymin===ymax?1:(v-ymin)/(ymax-ymin); return pad+H-a*H}
  ctx.moveTo(mapx(0),mapy(pts[0])); for(let i=1;i<n;i++) ctx.lineTo(mapx(i),mapy(pts[i])); ctx.stroke(); ctx.fillStyle='#e0e0e0'; ctx.fillText(label, pad+4, pad+12);
}
function lineageDepth(origin){ if(!origin) return 0; return (origin.match(/mut\(/g)||[]).length; }
function updateTaskCard(t){
  let c=document.getElementById(t.task);
  if(!c){ c=document.createElement("div"); c.id=t.task; c.className="task";
    c.innerHTML=`<strong>${t.task}</strong> <span class="small" id="${t.task}-depth"></span>
      <div>Gen: <span id="${t.task}-gen">0</span></div><div>Score: <span id="${t.task}-score">0</span></div>
      <div class='progress'><div id="${t.task}-bar" class='bar'></div></div>`; document.getElementById("tasks").appendChild(c); }
  if(typeof t.score==="number"){
    document.getElementById(t.task+"-gen").textContent=(t.gen??0); document.getElementById(t.task+"-score").textContent=t.score.toFixed(3);
    document.getElementById(t.task+"-bar").style.width=(Math.max(0,Math.min(1,t.score))*100)+"%";
    document.getElementById(t.task+"-depth").textContent="(depth "+lineageDepth(t.origin)+")";
  }
}
function appendLog(line){ const log=document.getElementById("log"); log.textContent+=line+"\n"; log.scrollTop=log.scrollHeight; }
ws.onmessage=(msg)=>{ try{ const d=JSON.parse(msg.data); if(d.event==="summary"){return;}
  if(d.event==="task_start"){ updateTaskCard({task:d.task,gen:0,score:0}); return; }
  if(d.event==="gen_tick"){ updateTaskCard(d);
    if(typeof d.ok_rate==="number"){ okPts.push(d.ok_rate); if(okPts.length>maxPoints) okPts.shift(); drawLine(document.getElementById("okChart"), okPts, "OK Rate"); }
    if(typeof d.avg_runtime==="number"){ rtPts.push(d.avg_runtime); if(rtPts.length>maxPoints) rtPts.shift(); drawLine(document.getElementById("rtChart"), rtPts, "Avg Runtime (s)"); } }
  appendLog(msg.data);
} catch(e){} };
</script></body></html>
